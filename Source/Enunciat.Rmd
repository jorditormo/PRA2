---
title: "PRA 2 - Com realitzar la neteja i l'anàlisi de dades?"
author: "Judith Cid, Jordi Tormo"
date: "2023-12-27"
output:
  html_document:
    toc: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_libraries, include=FALSE}
library(knitr)
```

# 1. Descripció del dataset.

El dataset "Heart Attack Analysis & Prediction" és un conjunt de dades que conté informació sobre persones que han patit un atac de cor. Aquest dataset és important perquè pot ser utilitzat per entrenar models de predicció per preveure qui és més propens a patir un atac de cor en el futur. El dataset pot ajudar a respondre a la pregunta de quins són els factors de risc més importants per a la salut cardiovascular.

El conjunt de dades s'ha obtingut de l'enllaç proporcionat a l'enunciat (<https://www.kaggle.com/datasets/rashikrahmanpritom/heart-attackanalysis-prediction-dataset>). Dels dos documents disponibles a l'enllaç, es treballarà amb el document `heart.csv`.

-   `age`: Edat del pacient
-   `sex`: Sexe del pacient
-   `cp` : Tipus de dolor toràcic.
    -   `1`: Angina de pit típica
    -   `2`: Angina de pit atípica
    -   `3`: Dolor no anginal
    -   `4`: Asimptomàtic
-   `trtbps`: Pressió arterial en repòs (in mm Hg)
-   `chol`: Colesterol en mg/dl obtingut mitjançant sensor d'IMC (índex de massa corporal)
-   `fbs`: Sucre en sang en dejú \> 120 mg/dl
    -   `1`: Vertader
    -   `0`: Fals
-   `restecg`: Resultats electrocardiogràfics en repòs
    -   `0`: Normal
    -   `1`: Té anomalia de l'ona ST-T (inversions d'ona T i/o elevació o depressió ST de \> 0,05 mV)
    -   `2`: Mostra una hipertròfia ventricular esquerra probable o definitiva segons el criteri d'Estes
-   `thalachh`: Freqüència cardíaca màxima aconseguida
-   `exng`: Exercici angina de pit induïda
    -   `1`: Sí
    -   `0`: No
-   `oldpeak`: Depressió de ST induïda per l'exercici en relació amb el descans
-   `slp`: El pendent del segment ST d'exercici màxim
    -   `0`: Sense inclinar
    -   `1`: Pla
    -   `2`: Baixada
-   `caa`: Nombre de vasos principals del cor (0-4)
-   `thall`: Talassèmia
    -   `0`: Nul
    -   `1`: Defecte solucionat
    -   `2`: Normal
    -   `3`: Defecte reversible
-   `output`: Diagnòstic de malalties cardíaques (estat de malaltia angiogràfica)
    -   `0`: Estrenyiment \< 50% del diàmetre. Menys possibilitats de patir malalties del cor.
    -   `1`: Estrenyiment \> 50% del diàmetre. Més possibilitats de patir malalties del cor.

# 2. Integració i selecció.

Integració i selecció de les dades d'interès a analitzar. Pot ser el resultat d'addicionar diferents datasets o una subselecció útil de les dades originals, en base a l'objectiu que es vulgui aconseguir.

S'utilitza el document `heart.csv` que consta de 303 registres i 14 atributs

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Es carrega el fitxer de dades en un objecte amb identificador denominat data
data_raw <- read.csv('../Dataset/heart.csv',header=T,sep=",")

# s'examinen els valors resum de cada tipus de variable
str(data_raw)
```

# 3. Neteja de les dades.

-   **3.1. Les dades contenen zeros o elements buits? Gestiona cadascun d'aquests casos.**

En primer lloc, es comprova que tots els atributs tenen sentit segons la seva descripció i valors possibles.

```{r}
data <- data_raw
summary(data)
```

```{r echo=TRUE, message=FALSE, warning=FALSE}

# --------------------
# cp
# --------------------
cat("\"Tipus de dolor toràcic\" (cp): \n")
cat("\t ·El número de zeros a l'atribut cp és:", nrow(data[data$cp == 0, ]) ,".\n")
cat("\t ·A part dels valors possibles (1, 2, 3 i 4) i elements buits, hi ha", sum(data$cp %in% c(0,1,2,3,4)) - nrow(data) ,"registres amb altres valors.\n")

# --------------------
# trtbps
# --------------------
cat("\"Pressió arterial en repòs (in mm Hg)\" (trtbps): \n")
if(nrow(data[data$trtbps == 0, ]) == 0){
  cat("\t ·No hi ha zeros a l'atribut trtbps.\n")
} else {
  cat("\t · S'han trobat", nrow(data[data$trtbps == 0, ]) , "zeros.\n")
}
if(nrow(data[data$trtbps < 0, ]) == 0) {
  cat("\t ·No hi ha valors negatius a l'atribut trtbps.\n")
} else {
  data[data$trtbps < 0,]$trtbps <- 0
  cat("\t ·Els valors negatius no són vàlids i s'han sobreescrit com a 0.\n")
}
if (all.equal(data$trtbps, as.integer(data$trtbps)) ){
  cat("\t ·Tots els valors són enters.\n")
} else {
  data[data$trtbps,]$trtbps = as.integer(data[data$trtbps,])
  cat("\t ·S'han trobat valors positius no enters i s'han sobreescrit per valors enters.\n")
}

# --------------------
# chol
# --------------------
cat("\"Colesterol en mg/dl\" (chol): \n")
if(nrow(data[data$chol == 0, ]) == 0){
  cat("\t ·No hi ha zeros a l'atribut chol\n")
} else {
  cat("\t · S'han trobat", nrow(data[data$chol == 0, ]) , "zeros.\n")
}
if(nrow(data[data$chol < 0, ]) == 0) {
  cat("\t ·No hi ha valors negatius a l'atribut chol\n")
} else {
  data[data$chol < 0,]$chol <- 0
  cat("\t ·Els valors negatius no són vàlids i s'han sobreescrit com a 0.\n")
}
if (all.equal(data$chol, as.integer(data$chol)) ){
  cat("\t ·Tots els valors són enters.\n")
} else {
  data[data$trtbps,]$chol = as.integer(data[data$chol,])
  cat("\t ·S'han trobat valors positius no enters i s'han sobreescrit per valors enters.\n")
}

# --------------------
# fbs
# --------------------
cat("\"Sucre en sang en dejú\" (fbs): \n")
cat("\t ·A part dels valors possibles (0, 1), hi ha", sum(data$fbs %in% c(0,1)) - nrow(data) ,"registres amb altres valors.\n")


# --------------------
# restecg
# --------------------
cat("\"Resultats electrocardiogràfics en repòs\" (restecg): \n")
cat("\t ·A part dels valors possibles (0, 1, 2), hi ha", sum(data$restecg %in% c(0,1,2)) - nrow(data) ,"registres amb altres valors.\n")

# --------------------
# thalachh
# --------------------
cat("\"Freqüència cardíaca màxima aconseguida\" (thalachh): \n")
if(nrow(data[data$thalachh == 0, ]) == 0){
  cat("\t ·No hi ha zeros a l'atribut thalachh\n")
} else {
  cat("\t · S'han trobat", nrow(data[data$thalachh == 0, ]), "zeros.\n")
}
if(nrow(data[data$thalachh < 0, ]) == 0) {
  cat("\t ·No hi ha valors negatius a l'atribut thalachh\n")
} else {
  data[data$thalachh < 0,]$thalachh <- 0
  cat("\t ·Els valors negatius no són vàlids i s'han sobreescrit com 0.\n")
}
if (all.equal(data$thalachh, as.integer(data$thalachh)) ){
  cat("\t ·Tots els valors són enters.\n")
} else {
  data[data$trtbps,]$thalachh = as.integer(data[data$thalachh,])
  cat("\t ·S'han trobat valors positius no enters i s'han sobreescrit per valors enters.\n")
}

# --------------------
# exng
# --------------------
cat("\"Exercici angina de pit induïda\" (exng): \n")
cat("\t ·A part dels valors possibles (0, 1), hi ha", sum(data$exng %in% c(0,1)) - nrow(data) ,"registres amb altres valors.\n")

# --------------------
# oldpeak
# --------------------
cat("\"Depressió de ST induïda per l’exercici en relació amb el descans\" (oldpeak): \n")
if(nrow(data[data$oldpeak == 0, ]) == 0){
  cat("\t ·No hi ha zeros a l'atribut oldpeak\n")
} else {
  cat("\t · S'han trobat", nrow(data[data$oldpeak == 0, ]) , "zeros.\n")
}
if(nrow(data[data$oldpeak < 0, ]) == 0) {
  cat("\t · No hi ha valors negatius a l'atribut oldpeak\n")
} else {
  data[data$oldpeak < 0,]$oldpeak <- 0
  cat("\t · Els valors negatius no són vàlids i s'han sobreescrit com a 0.\n")
}
data$oldpeak <- as.numeric(data$oldpeak)

# --------------------
# slp
# --------------------
cat("\"El pendent del segment ST d’exercici màxim\" (slp): \n")
cat("\t ·A part dels valors possibles (0, 1, 2), hi ha", sum(data$slp %in% c(0,1,2)) - nrow(data) ,"registres amb altres valors.\n")

# --------------------
# caa
# --------------------
cat("\"Nombre de vasos principals del cor\" (caa): \n")
cat("\t ·A part dels valors possibles (0, 1, 2, 3, 4), hi ha", sum(data$caa %in% c(0,1,2,3,4)) - nrow(data) ,"registres amb altres valors.\n")

# --------------------
# thall
# --------------------
cat("\" Talassèmia\" (thall): \n")
cat("\t ·A part dels valors possibles (0, 1, 2, 3, 4), hi ha", sum(data$thall %in% c(0,1,2,3,4)) - nrow(data) ,"registres amb altres valors.\n")

# --------------------
# output
# --------------------
cat("\"Diagnòstic de malalties cardíaques\" (output): \n")
cat("\t ·A part dels valors possibles (0, 1), hi ha", sum(data$output %in% c(0,1,2,3)) - nrow(data) ,"registres amb altres valors.\n")

```

Veiem com la única variable amb anomàlies és "cp" (Tipus de dolor toràcic). Aquesta variable té 143 zeros quan els seus únics valors possibles són 1, 2, 3 o 4. Com es tracta gairebé d'un 50% a zeros, no utilitzarem aquesta variable en la nostra anàlisi, ja que no aportaria informació.

```{r}
data <- data[, setdiff(names(data), "cp")]
str(data)
```

-   **3.2. Identifica i gestiona els valors extrems.**

Per poder veure les distribucions de les variables e identificar els valors extrems o outliers, presentem uns gràfics de tipus boxplot per a les variables numèriques:

```{r echo=TRUE, message=FALSE, warning=FALSE}

data_num <- data[,c('age', 'trtbps', 'chol', 'thalachh', 'oldpeak')]

par(mfrow=c(1,5),mai=c(0.1, 0.0, 0.2, 0.3))
par(oma=c(0, 2, 0, 0) + 0.1)
for (i in colnames(data_num)) boxplot(data_num[i], main = i)

```

En aquests gràfics podem veure que totes les columnes excepte "age" tenen punts individuals fora de les bigues, aquests valors són els que s'han considerat com extrems. A continuació es mostren aquests outliers per a cada variable:

Valors extrems de la variable "trtbps" (Pressió arterial en repòs (in mm Hg)):

```{r}
res_trtbps <- boxplot(data$trtbps,plot=FALSE)$out
res_trtbps
```

Valors extrems de la variable "Chol" (Colesterol en mg/dl obtingut mitjançant sensor d'IMC (índex de massa corporal)):

```{r}
res_chol <- boxplot(data$chol,plot=FALSE)$out
res_chol
```

Valors extrems de la variable "thalachh" (Freqüència cardíaca màxima aconseguida):

```{r}
res_thalachh <- boxplot(data$thalachh,plot=FALSE)$out
res_thalachh
```

Valors extrems de la variable "oldpeak" (Depressió de ST induïda per l'exercici en relació amb el descans):

```{r}
res_oldpeak <- boxplot(data$oldpeak,plot=FALSE)$out
res_oldpeak
```

Per gestionar aquests valors outliers s'ha decidit passar-los a NA's per imputar-los, després, utilitzant l'algorisme d'aprenentatge no supervisat KNN. Aquest algorisme es basa en el principi que els punts de dades similars tindran valors similars.

Passem a NA tots els outliers:

```{r}
data$trtbps[data$trtbps %in% res_trtbps] <- NA
data$chol[data$chol %in% res_chol] <- NA
data$thalachh[data$thalachh %in% res_thalachh] <- NA
data$oldpeak[data$oldpeak %in% res_oldpeak] <- NA
```

Apliquem KNN a les quatre variables amb un nombre de veïns k igual a 5:

```{r}
if(!require('VIM')) install.packages('VIM'); library('VIM')

dfTrtbpsImp <- kNN(data, variable=c("trtbps"), k = 5)
dfCholImp <- kNN(data, variable=c("chol"), k = 5)
dfThalachhImp <- kNN(data, variable=c("thalachh"), k = 5)
dfOldpeakImp <- kNN(data, variable=c("oldpeak"), k = 5)


data$trtbps <- dfTrtbpsImp$trtbps
data$chol <- dfCholImp$chol
data$thalachh <- dfThalachhImp$thalachh
data$oldpeak <- dfOldpeakImp$oldpeak
```

Presentem un altre cop el gràfic boxplot per comprovar que efectivament ja no hi ha valors extrems en les dades numèriques:

```{r echo=TRUE, message=FALSE, warning=FALSE}

data_num <- data[,c('age', 'trtbps', 'chol', 'thalachh', 'oldpeak')]

par(mfrow=c(1,5),mai=c(0.1, 0.0, 0.2, 0.3))
par(oma=c(0, 2, 0, 0) + 0.1)
for (i in colnames(data_num)) boxplot(data_num[i], main = i)
```

# 4. Anàlisi de les dades.

-   **4.1. Selecció dels grups de dades que es volen analitzar/comparar (p. e., si es volen comparar grups de dades, quins són aquests grups i quins tipus d'anàlisi s'aplicaran?).**

-   **4.2. Comprovació de la normalitat i homogeneïtat de la variància.**

-   **4.3. Aplicació de proves estadístiques per comparar els grups de dades. En funció de les dades i de l'objectiu de l'estudi, aplicar proves de contrast d'hipòtesis, correlacions, regressions, etc. Aplicar almenys tres mètodes d'anàlisi diferents.**

    Segons la descripció dels valors interessa factorizar-ne alguns ja que són variables categòriques amb un número finit de valors.

    ```{r echo=TRUE, message=FALSE, warning=FALSE}
    data$sex <- as.factor(data$sex)
    #data$cp <- as.factor(data$cp)
    data$fbs <- as.factor(data$fbs)
    data$restecg <- as.factor(data$restecg)
    data$exng <- as.factor(data$exng)
    data$slp <- as.factor(data$slp)
    data$caa <- as.factor(data$caa)
    data$thall <- as.factor(data$thall)
    data$output <- as.factor(data$output)

    # valors numèrics i categòrics separats
    data_num <- data[,c('age', 'trtbps', 'chol', 'thalachh')]
    data_cat <- data[,c('sex','fbs', 'restecg', 'exng', 'slp', 'caa', 'thall', 'output')]
    str(data)
    ```

```{r echo=TRUE, message=FALSE, warning=FALSE}
if(!require("corrplot")) install.packages("corrplot"); library("corrplot")
if(!require('dplyr')) install.packages('dplyr'); library('dplyr')

res<-cor(data_num_norm)
corrplot(res, method="color",tl.col="black", tl.srt=30, order = "AOE", 
   number.cex=0.75,sig.level = 0.01, addCoef.col = "black")
```

# 5. Representació dels resultats a partir de taules i gràfiques.

Aquest apartat es pot respondre al llarg de la pràctica, sense la necessitat de concentrar totes les representacions en aquest punt de la pràctica.

# 6. Resolució del problema.

A partir dels resultats obtinguts, quines són les conclusions? Els resultats permeten respondre al problema?

# 7. Codi.

Cal adjuntar el codi, preferiblement en R, amb el que s'ha realitzat la neteja, anàlisi i representació de les dades. Si ho preferiu, també podeu treballar en Python.

# 8. Vídeo.

Realitzar un breu vídeo explicatiu de la pràctica (màxim 10 minuts) on tots els integrants de l'equip expliquin amb les seves pròpies paraules el desenvolupament de la pràctica, basant-se en les preguntes de l'enunciat per a justificar i explicar el codi desenvolupat. Aquest vídeo s'haurà de lliurar a través d'un enllaç al Google Drive de la UOC (<https://drive.google.com/>...), juntament amb l'enllaç al repositori Git lliurat.
